name: Build Dockerfile and Save as TAR

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      dockerfile_path:
        description: 'Dockerfile è·¯å¾„ï¼ˆç›¸å¯¹äºä»“åº“æ ¹ç›®å½•ï¼Œä¾‹å¦‚ï¼šDockerfile æˆ– ./docker/Dockerfileï¼‰'
        required: true
        default: 'examples/simple-docker/Dockerfile'
      image_name:
        description: 'æ„å»ºåçš„é•œåƒåç§°å’Œæ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼šmyapp:latestï¼‰'
        required: true
        default: 'myapp:latest'
      build_context:
        description: 'æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„ï¼ˆé»˜è®¤ä¸º Dockerfile æ‰€åœ¨ç›®å½•ï¼‰'
        required: false
        default: 'examples/simple-docker'
      enable_release:
        description: 'æ˜¯å¦ä¸Šä¼ åˆ° GitHub Release'
        required: false
        default: false
        type: boolean
      enable_ftp:
        description: 'æ˜¯å¦å¯ç”¨ FTP ä¸Šä¼ '
        required: false
        default: true
        type: boolean
      ftp_port:
        description: 'FTP ç«¯å£ï¼ˆé»˜è®¤ï¼š21ï¼‰'
        required: false
        default: '21'
      ftp_path:
        description: 'FTP ç›®æ ‡è·¯å¾„ï¼ˆä¾‹å¦‚ï¼š/docker-images/ï¼‰'
        required: false
        default: '/'
      enable_dockerhub_push:
        description: 'æ˜¯å¦æ¨é€åˆ° Docker Hub'
        required: false
        default: false
        type: boolean
      dockerhub_image_name:
        description: 'Docker Hub ä¸Šçš„é•œåƒåç§°ï¼ˆä¾‹å¦‚ï¼šusername/myapp:latestï¼‰ã€‚ç•™ç©ºåˆ™ä½¿ç”¨æ„å»ºæ—¶çš„é•œåƒå'
        required: false
        default: ''
      dockerhub_visibility:
        description: 'Docker Hub ä»“åº“å¯è§æ€§'
        required: false
        default: 'public'
        type: choice
        options:
          - 'public'
          - 'private'

jobs:
  build-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Display Build Configuration
        run: |
          echo "=========================================="
          echo "Dockerfile Builder"
          echo "=========================================="
          echo "Dockerfile è·¯å¾„: ${{ github.event.inputs.dockerfile_path }}"
          echo "é•œåƒåç§°: ${{ github.event.inputs.image_name }}"
          echo "æ„å»ºä¸Šä¸‹æ–‡: ${{ github.event.inputs.build_context }}"
          echo "=========================================="

      - name: Verify Dockerfile Exists
        run: |
          if [ ! -f "${{ github.event.inputs.dockerfile_path }}" ]; then
            echo "âŒ é”™è¯¯: Dockerfile æ–‡ä»¶ä¸å­˜åœ¨äº ${{ github.event.inputs.dockerfile_path }}"
            echo "è¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®"
            exit 1
          fi
          echo "âœ… Dockerfile æ–‡ä»¶å­˜åœ¨"
          echo ""
          echo "Dockerfile å†…å®¹é¢„è§ˆ:"
          echo "=========================================="
          cat "${{ github.event.inputs.dockerfile_path }}"
          echo "=========================================="

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker Data Directory to /mnt
        run: |
          echo "=========================================="
          echo "é…ç½® Docker æ•°æ®ç›®å½•åˆ° /mntï¼ˆè§£å†³æ ¹åˆ†åŒºç©ºé—´ä¸è¶³é—®é¢˜ï¼‰"
          echo "=========================================="
          # åœæ­¢ Docker daemon
          sudo systemctl stop docker docker.socket containerd
          # åˆ›å»º /mnt/docker ç›®å½•
          sudo mkdir -p /mnt/docker
          # å¤‡ä»½ç°æœ‰ Docker æ•°æ®
          if [ -d /var/lib/docker ] && [ ! -L /var/lib/docker ]; then
            echo "ç§»åŠ¨ç°æœ‰ Docker æ•°æ®åˆ° /mnt/docker..."
            sudo mv /var/lib/docker/* /mnt/docker/ 2>/dev/null || true
          fi
          # é…ç½® Docker daemon ä½¿ç”¨ /mnt/docker
          echo '{"data-root": "/mnt/docker"}' | sudo tee /etc/docker/daemon.json
          # é‡æ–°å¯åŠ¨ Docker
          sudo systemctl start docker
          # éªŒè¯é…ç½®
          echo "Docker æ•°æ®æ ¹ç›®å½•:"
          docker info | grep "Docker Root Dir"
          echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h /mnt/docker
          echo "=========================================="

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: ${{ github.event.inputs.enable_dockerhub_push != 'true' }}
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Verify Docker Hub Authentication
        if: ${{ github.event.inputs.enable_dockerhub_push == 'true' }}
        run: |
          echo "=========================================="
          echo "Docker Hub è®¤è¯çŠ¶æ€æ£€æŸ¥"
          echo "=========================================="

          # æ£€æŸ¥æ˜¯å¦é…ç½®äº†å¿…è¦çš„ Secrets
          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "âŒ é”™è¯¯: DOCKERHUB_TOKEN æœªé…ç½®"
            echo ""
            echo "è¯·åœ¨ GitHub Secrets ä¸­é…ç½®:"
            echo "  - DOCKERHUB_TOKEN: Docker Hub è®¿é—®ä»¤ç‰Œ"
            echo "  - DOCKERHUB_USERNAME: Docker Hub ç”¨æˆ·å"
            exit 1
          fi

          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "âŒ é”™è¯¯: DOCKERHUB_USERNAME æœªé…ç½®"
            echo ""
            echo "è¯·åœ¨ GitHub Secrets ä¸­é…ç½® DOCKERHUB_USERNAME"
            exit 1
          fi

          echo "âœ… DOCKERHUB_TOKEN å·²é…ç½®"
          echo "âœ… DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}"

          # éªŒè¯ç™»å½•çŠ¶æ€
          echo ""
          echo "éªŒè¯ Docker Hub ç™»å½•çŠ¶æ€..."
          if docker info 2>/dev/null | grep -q "Username"; then
            echo "âœ… Docker Hub ç™»å½•æˆåŠŸ"
            docker info | grep "Username"
          else
            echo "âŒ Docker Hub ç™»å½•å¤±è´¥"
            echo ""
            echo "è¯·æ£€æŸ¥:"
            echo "1. DOCKERHUB_TOKEN æ˜¯å¦æ­£ç¡®ä¸”æœªè¿‡æœŸ"
            echo "2. DOCKERHUB_USERNAME æ˜¯å¦æ­£ç¡®"
            echo "3. Token æ˜¯å¦å…·æœ‰è¯»å†™æƒé™"
            exit 1
          fi
          echo "=========================================="

      - name: Check Disk Space Before Build
        run: |
          echo "=========================================="
          echo "æ„å»ºå‰ç£ç›˜ç©ºé—´æ£€æŸ¥"
          echo "=========================================="
          df -h
          echo ""
          echo "Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          docker system df
          echo "=========================================="

      - name: Build Docker Image
        run: |
          set -e  # ç¡®ä¿ä»»ä½•é”™è¯¯éƒ½åœæ­¢æ‰§è¡Œ

          echo "=========================================="
          echo "å¼€å§‹æ„å»º Docker é•œåƒ"
          echo "=========================================="
          echo "é•œåƒåç§°: ${{ github.event.inputs.image_name }}"
          echo "æ„å»ºä¸Šä¸‹æ–‡: ${{ github.event.inputs.build_context }}"
          echo "Dockerfile: ${{ github.event.inputs.dockerfile_path }}"

          # è¿›å…¥æ„å»ºä¸Šä¸‹æ–‡ç›®å½•
          cd "${{ github.event.inputs.build_context }}"

          # è®¡ç®—ç›¸å¯¹è·¯å¾„
          BUILD_CONTEXT="${{ github.event.inputs.build_context }}"
          DOCKERFILE="${{ github.event.inputs.dockerfile_path }}"

          # å¦‚æœ Dockerfile åœ¨æ„å»ºä¸Šä¸‹æ–‡å†…éƒ¨ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„
          if [[ "$DOCKERFILE" == "$BUILD_CONTEXT"* ]]; then
            # ç§»é™¤æ„å»ºä¸Šä¸‹æ–‡å‰ç¼€ï¼Œå¾—åˆ°ç›¸å¯¹äºæ„å»ºä¸Šä¸‹æ–‡çš„è·¯å¾„
            RELATIVE_DOCKERFILE="${DOCKERFILE#$BUILD_CONTEXT/}"
            echo "ä½¿ç”¨ç›¸å¯¹ Dockerfile è·¯å¾„: $RELATIVE_DOCKERFILE"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "Dockerfile å­˜åœ¨æ£€æŸ¥: $(test -f "$RELATIVE_DOCKERFILE" && echo 'å­˜åœ¨' || echo 'ä¸å­˜åœ¨')"
            echo ""
            echo "å¼€å§‹æ„å»º..."
            echo "=========================================="

            docker build \
              -f "$RELATIVE_DOCKERFILE" \
              -t "${{ github.event.inputs.image_name }}" \
              . || {
                echo "=========================================="
                echo "âŒ æ„å»ºå¤±è´¥ï¼"
                echo "è¯·æ£€æŸ¥ Dockerfile å†…å®¹å’Œæ„å»ºæ—¥å¿—"
                exit 1
              }
          else
            # Dockerfile åœ¨æ„å»ºä¸Šä¸‹æ–‡å¤–éƒ¨ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„
            echo "ä½¿ç”¨ç»å¯¹ Dockerfile è·¯å¾„: $DOCKERFILE"
            echo ""
            echo "å¼€å§‹æ„å»º..."
            echo "=========================================="

            docker build \
              -f "../$DOCKERFILE" \
              -t "${{ github.event.inputs.image_name }}" \
              . || {
                echo "=========================================="
                echo "âŒ æ„å»ºå¤±è´¥ï¼"
                echo "è¯·æ£€æŸ¥ Dockerfile å†…å®¹å’Œæ„å»ºæ—¥å¿—"
                exit 1
              }
          fi

          echo ""
          echo "=========================================="
          echo "âœ… æ„å»ºæˆåŠŸï¼"
          echo "=========================================="

      - name: Display Image Details
        run: |
          echo "æ„å»ºå®Œæˆçš„é•œåƒä¿¡æ¯:"
          docker images ${{ github.event.inputs.image_name }}
          echo ""
          echo "é•œåƒè¯¦ç»†ä¿¡æ¯:"
          docker inspect ${{ github.event.inputs.image_name }} --format='{{.Id}}'
          docker inspect ${{ github.event.inputs.image_name }} --format='æ„å»ºæ—¶é—´: {{.Created}}'
          docker inspect ${{ github.event.inputs.image_name }} --format='é•œåƒå¤§å°: {{.Size}}'

      - name: Clean Docker Cache Before Save
        run: |
          echo "=========================================="
          echo "æ¸…ç† Docker ç³»ç»Ÿä»¥é‡Šæ”¾ç©ºé—´ï¼ˆä¿ç•™æ„å»ºå¥½çš„é•œåƒï¼‰"
          echo "=========================================="
          # æ¸…ç†æ„å»ºç¼“å­˜
          docker builder prune -af
          # åªæ¸…ç†æ‚¬æŒ‚é•œåƒï¼ˆdanglingï¼‰ï¼Œä¸åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒ
          docker image prune -f
          # æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨ã€ç½‘ç»œï¼ˆä¸æ¸…ç†å·ï¼Œé¿å…å½±å“æ•°æ®ï¼‰
          docker system prune -f
          # è®¾ç½® /mnt ç›®å½•æƒé™ï¼ˆå…è®¸å½“å‰ç”¨æˆ·å†™å…¥ï¼‰
          sudo mkdir -p /mnt
          sudo chmod 777 /mnt
          echo "æ¸…ç†å®Œæˆåçš„ç£ç›˜ç©ºé—´:"
          df -h
          echo "=========================================="

      - name: Save Image as TAR
        run: |
          # éªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨
          echo "æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨: ${{ github.event.inputs.image_name }}"
          if ! docker inspect ${{ github.event.inputs.image_name }} >/dev/null 2>&1; then
            echo "âŒ é”™è¯¯: é•œåƒ ${{ github.event.inputs.image_name }} ä¸å­˜åœ¨"
            echo ""
            echo "å¯ç”¨çš„é•œåƒåˆ—è¡¨:"
            docker images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}"
            echo ""
            echo "è¯·æ£€æŸ¥æ„å»ºæ­¥éª¤æ˜¯å¦æˆåŠŸå®Œæˆ"
            exit 1
          fi
          echo "âœ… é•œåƒå­˜åœ¨ï¼Œç»§ç»­å¯¼å‡º"

          # å°†é•œåƒåç§°ä¸­çš„ / å’Œ : æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œä½œä¸ºæ–‡ä»¶å
          SAFE_NAME=$(echo "${{ github.event.inputs.image_name }}" | sed 's/[\/:]/_/g')
          # ä¿å­˜åˆ° /mnt ç›®å½•ï¼ˆGitHub Actions é¢å¤–ç£ç›˜ç©ºé—´ï¼Œçº¦ 14GBï¼‰
          IMAGE_FILE="/mnt/${SAFE_NAME}.tar"
          echo "IMAGE_FILE=${IMAGE_FILE}" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=docker-image-${SAFE_NAME}" >> $GITHUB_ENV
          echo "æ­£åœ¨ä¿å­˜é•œåƒä¸º: ${IMAGE_FILE}"

          # æ˜¾ç¤ºå„ä¸ªæŒ‚è½½ç‚¹çš„ç£ç›˜ç©ºé—´
          echo "=== ç£ç›˜ç©ºé—´ä¿¡æ¯ ==="
          df -h | grep -E "(/mnt|Filesystem|/dev/)"
          echo "=================="

          # æ˜¾ç¤ºé•œåƒå¤§å°ä¿¡æ¯
          IMAGE_SIZE=$(docker inspect ${{ github.event.inputs.image_name }} --format='{{.Size}}' | awk '{print int($1/1024/1024/1024)}')
          echo "é•œåƒå¤§å°: ${IMAGE_SIZE}GB"
          echo "æ ¹åˆ†åŒºå¯ç”¨: $(df -h / | awk 'NR==2 {print $4}')"
          echo "/mnt åˆ†åŒºå¯ç”¨: $(df -h /mnt | awk 'NR==2 {print $4}')"

          # æ£€æŸ¥ /mnt ç›®å½•çš„å¯ç”¨ç©ºé—´
          AVAILABLE_SPACE=$(df -BG /mnt | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "/mnt å¯ç”¨ç©ºé—´: ${AVAILABLE_SPACE}GB"

          # è®¡ç®—æ‰€éœ€ç©ºé—´ï¼ˆé•œåƒå¤§å° + 2GB ç¼“å†²ï¼‰
          REQUIRED_SPACE=$((IMAGE_SIZE + 2))
          echo "é¢„ä¼°éœ€è¦ç©ºé—´: ${REQUIRED_SPACE}GB"

          if [ "$AVAILABLE_SPACE" -lt "$REQUIRED_SPACE" ]; then
            echo "âŒ é”™è¯¯: /mnt ç£ç›˜ç©ºé—´ä¸è¶³"
            echo "éœ€è¦: ${REQUIRED_SPACE}GB, å¯ç”¨: ${AVAILABLE_SPACE}GB"
            echo "å»ºè®®: é•œåƒå¤ªå¤§ï¼Œå³ä½¿ä½¿ç”¨ /mnt ç›®å½•ä¹Ÿä¸å¤Ÿ"
            exit 1
          fi

          echo ""
          echo "å¼€å§‹å¯¼å‡ºé•œåƒï¼ˆä½¿ç”¨ç®¡é“ç›´æ¥å†™å…¥ /mntï¼Œé¿å…ä¸´æ—¶æ–‡ä»¶å ç”¨æ ¹åˆ†åŒºï¼‰..."
          # ä½¿ç”¨ç®¡é“æ–¹å¼ä¿å­˜ï¼Œé¿å…åœ¨ /var/lib/docker/tmp åˆ›å»ºä¸´æ—¶æ–‡ä»¶
          docker save ${{ github.event.inputs.image_name }} > ${IMAGE_FILE}

      - name: Push to Docker Hub
        if: ${{ github.event.inputs.enable_dockerhub_push == 'true' }}
        run: |
          echo "=========================================="
          echo "å¼€å§‹æ¨é€åˆ° Docker Hub"
          echo "=========================================="

          # ç¡®å®šç›®æ ‡é•œåƒåç§°
          LOCAL_IMAGE="${{ github.event.inputs.image_name }}"
          HUB_IMAGE="${{ github.event.inputs.dockerhub_image_name }}"
          VISIBILITY="${{ github.event.inputs.dockerhub_visibility }}"
          DH_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"

          if [ -z "$HUB_IMAGE" ]; then
            HUB_IMAGE="$LOCAL_IMAGE"
            echo "æœªæŒ‡å®š Docker Hub é•œåƒåï¼Œä½¿ç”¨æ„å»ºé•œåƒå: $HUB_IMAGE"
          else
            echo "Docker Hub é•œåƒå: $HUB_IMAGE"
          fi

          echo "æœ¬åœ°é•œåƒ: $LOCAL_IMAGE"
          echo "ç›®æ ‡é•œåƒ: $HUB_IMAGE"
          echo "ä»“åº“å¯è§æ€§: $VISIBILITY"
          echo ""

          # éªŒè¯é•œåƒåç§°æ ¼å¼
          if [[ ! "$HUB_IMAGE" =~ .+/.+ ]]; then
            echo "âŒ é”™è¯¯: é•œåƒåç§°æ ¼å¼ä¸æ­£ç¡®"
            echo ""
            echo "å½“å‰é•œåƒå: $HUB_IMAGE"
            echo "æ­£ç¡®æ ¼å¼åº”ä¸º: username/imagename:tag"
            echo ""
            echo "ä¾‹å¦‚:"
            echo "  - $DH_USERNAME/myapp:latest"
            echo "  - $DH_USERNAME/myapp:v1.0.0"
            echo ""
            echo "è§£å†³æ–¹æ¡ˆ:"
            echo "1. åœ¨ dockerhub_image_name å‚æ•°ä¸­æŒ‡å®šå®Œæ•´çš„é•œåƒå"
            echo "2. æˆ–è€…ä¿®æ”¹ image_name å‚æ•°ï¼Œæ·»åŠ ç”¨æˆ·åå‰ç¼€"
            exit 1
          fi

          # æ£€æŸ¥é•œåƒç”¨æˆ·åæ˜¯å¦ä¸ç™»å½•ç”¨æˆ·ååŒ¹é…
          IMAGE_USERNAME=$(echo "$HUB_IMAGE" | cut -d'/' -f1)
          if [ "$IMAGE_USERNAME" != "$DH_USERNAME" ]; then
            echo "âš ï¸  è­¦å‘Š: é•œåƒæ‰€å±ç”¨æˆ· ($IMAGE_USERNAME) ä¸ç™»å½•ç”¨æˆ· ($DH_USERNAME) ä¸ä¸€è‡´"
            echo ""
            echo "è¿™å¯èƒ½å¯¼è‡´æ¨é€å¤±è´¥ï¼Œå› ä¸ºæ‚¨å¯èƒ½æ²¡æœ‰æ¨é€åˆ°å…¶ä»–ç”¨æˆ·ä»“åº“çš„æƒé™"
            echo ""
            echo "è¯·ç¡®ä¿:"
            echo "1. æ‚¨æœ‰æ¨é€åˆ° $IMAGE_USERNAME ä»“åº“çš„æƒé™"
            echo "2. æˆ–è€…ä½¿ç”¨ $DH_USERNAME/your-app:tag æ ¼å¼çš„é•œåƒå"
            echo ""
          fi

          # å¦‚æœé•œåƒåä¸åŒï¼Œéœ€è¦æ‰“æ ‡ç­¾
          if [ "$LOCAL_IMAGE" != "$HUB_IMAGE" ]; then
            echo "ä¸ºé•œåƒæ‰“æ ‡ç­¾..."
            docker tag "$LOCAL_IMAGE" "$HUB_IMAGE"
          fi

          echo "å¼€å§‹æ¨é€é•œåƒåˆ° Docker Hub..."
          echo "=========================================="

          # æ¨é€é•œåƒ
          docker push "$HUB_IMAGE" || {
            echo "=========================================="
            echo "âŒ æ¨é€å¤±è´¥ï¼"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            echo "1. Docker Hub Token æœªé…ç½®æˆ–æ— æ•ˆ"
            echo "2. é•œåƒåç§°æ ¼å¼ä¸æ­£ç¡®ï¼ˆåº”ä¸º username/imagename:tagï¼‰"
            echo "3. æ²¡æœ‰æ¨é€åˆ°ç›®æ ‡ä»“åº“çš„æƒé™"
            echo ""
            echo "è¯·æ£€æŸ¥ GitHub Secrets ä¸­çš„ DOCKERHUB_TOKEN å’Œ DOCKERHUB_USERNAME"
            echo "=========================================="
            exit 1
          }

          echo ""
          echo "=========================================="
          echo "âœ… æ¨é€æˆåŠŸï¼"
          echo "=========================================="

          # è®¾ç½®ä»“åº“å¯è§æ€§
          echo ""
          echo "è®¾ç½®ä»“åº“å¯è§æ€§ä¸º: $VISIBILITY"

          # è§£æé•œåƒåç§°ï¼ˆå»é™¤ tagï¼Œè·å– namespace/repoï¼‰
          # ä¾‹å¦‚: username/myapp:latest -> username/myapp
          REPO_PATH=$(echo "$HUB_IMAGE" | cut -d':' -f1)

          # æ£€æŸ¥é•œåƒåç§°æ ¼å¼ï¼ˆç®€å•éªŒè¯ï¼šåŒ…å«æ–œæ ä¸”ä¸ä¸ºç©ºï¼‰
          if [[ ! "$REPO_PATH" =~ .+/.+ ]]; then
            echo "âš ï¸  è­¦å‘Š: é•œåƒåç§°æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼Œè·³è¿‡è®¾ç½®å¯è§æ€§"
            echo "   æ­£ç¡®æ ¼å¼åº”ä¸º: username/reponame"
          else
            # è°ƒç”¨ Docker Hub API è®¾ç½®å¯è§æ€§
            API_RESPONSE=$(curl -s -X PATCH \
              "https://hub.docker.com/v2/repositories/${REPO_PATH}/" \
              -H "Authorization: Bearer ${{ secrets.DOCKERHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "{\"visibility\": \"${VISIBILITY}\"}" \
              -w "\n%{http_code}")

            # åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
            HTTP_CODE=$(echo "$API_RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$API_RESPONSE" | head -n-1)

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
              echo "âœ… ä»“åº“å¯è§æ€§å·²è®¾ç½®ä¸º: $VISIBILITY"
            else
              echo "âš ï¸  è®¾ç½®å¯è§æ€§å¤±è´¥ (HTTP $HTTP_CODE)"
              echo "å“åº”: $RESPONSE_BODY"
              echo "æç¤º: ä»“åº“å¯èƒ½å·²è®¾ç½®ä¸ºæ­¤å¯è§æ€§ï¼Œæˆ– Token æƒé™ä¸è¶³"
            fi
          fi

          echo ""
          echo "=========================================="
          echo "é•œåƒå·²ä¸Šä¼ åˆ° Docker Hub:"
          echo "  $HUB_IMAGE"
          echo "  å¯è§æ€§: $VISIBILITY"
          echo ""
          echo "æ‹‰å–å‘½ä»¤:"
          echo "  docker pull $HUB_IMAGE"
          echo "=========================================="

      - name: Display TAR File Size
        run: |
          echo "TAR æ–‡ä»¶ä¿¡æ¯:"
          ls -lh ${{ env.IMAGE_FILE }}
          echo "æ–‡ä»¶å¤§å°è¯¦æƒ…:"
          du -h ${{ env.IMAGE_FILE }}
          echo ""
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file ${{ env.IMAGE_FILE }}

      - name: Generate Release Info
        if: ${{ github.event.inputs.enable_release == 'true' }}
        run: |
          # ç”Ÿæˆæ—¶é—´æˆ³ä½œä¸º Release tag
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "RELEASE_TAG=docker-build-${TIMESTAMP}" >> $GITHUB_ENV
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV

      - name: Create Release and Upload TAR
        if: ${{ github.event.inputs.enable_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "${{ env.ARTIFACT_NAME }} - ${{ env.TIMESTAMP }}"
          body: |
            ## Docker é•œåƒæ„å»ºå¯¼å‡º

            - **é•œåƒåç§°**: `${{ github.event.inputs.image_name }}`
            - **Dockerfile è·¯å¾„**: `${{ github.event.inputs.dockerfile_path }}`
            - **æ„å»ºæ—¶é—´**: ${{ env.TIMESTAMP }}
            - **æ–‡ä»¶å¤§å°**: ${{ env.IMAGE_FILE }}

            ### ä½¿ç”¨æ–¹æ³•

            ```bash
            # ä¸‹è½½ååŠ è½½é•œåƒ
            docker load -i ${{ env.IMAGE_FILE }}

            # è¿è¡Œé•œåƒ
            docker run -it ${{ github.event.inputs.image_name }}
            ```

            ### æ„å»ºä¿¡æ¯
            - æ­¤é•œåƒä» Dockerfile æ„å»ºè€Œæ¥
            - å¯åœ¨ç¦»çº¿ç¯å¢ƒä¸­ä½¿ç”¨
          files: ${{ env.IMAGE_FILE }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to FTP
        if: ${{ github.event.inputs.enable_ftp == 'true' }}
        run: |
          echo "=========================================="
          echo "å¼€å§‹ä¸Šä¼ åˆ° FTP æœåŠ¡å™¨"
          echo "=========================================="
          echo "FTP æœåŠ¡å™¨: *** (å·²é…ç½®)"
          echo "FTP ç«¯å£: ${{ github.event.inputs.ftp_port }}"
          echo "FTP è·¯å¾„: ${{ github.event.inputs.ftp_path }}"
          echo "æ–‡ä»¶: ${{ env.IMAGE_FILE }}"

          # ç¡®ä¿è·¯å¾„ä»¥ / ç»“å°¾
          FTP_PATH="${{ github.event.inputs.ftp_path }}"
          if [[ "${FTP_PATH: -1}" != "/" ]]; then
            FTP_PATH="${FTP_PATH}/"
          fi

          # ä½¿ç”¨ curl ä¸Šä¼ æ–‡ä»¶åˆ° FTP
          curl -T "${{ env.IMAGE_FILE }}" \
            "ftp://${{ secrets.FTP_SERVER }}:${{ github.event.inputs.ftp_port }}${FTP_PATH}${{ env.IMAGE_FILE }}" \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
            --ftp-create-dirs \
            -v

          echo "=========================================="
          echo "âœ… FTP ä¸Šä¼ å®Œæˆ!"
          echo "=========================================="

      - name: Summary
        run: |
          echo "=========================================="
          echo "âœ… æ„å»ºä»»åŠ¡å®Œæˆ!"
          echo "=========================================="
          echo "é•œåƒåç§°: ${{ github.event.inputs.image_name }}"
          echo "é•œåƒå·²ä¿å­˜ä¸º: ${{ env.IMAGE_FILE }}"
          echo "Dockerfile è·¯å¾„: ${{ github.event.inputs.dockerfile_path }}"

          # æ ¹æ® Release å¼€å…³çŠ¶æ€æ˜¾ç¤ºä¸åŒä¿¡æ¯
          if [[ "${{ github.event.inputs.enable_release }}" == "true" ]]; then
            echo "âœ… å·²ä¸Šä¼ åˆ° GitHub Release"
            echo "Release Tag: ${{ env.RELEASE_TAG }}"
            echo "è¯·åœ¨ä¸‹æ–¹çš„ Releases åŒºåŸŸä¸‹è½½æ–‡ä»¶"
          else
            echo "â­ï¸  å·²è·³è¿‡ GitHub Release ä¸Šä¼ "
          fi

          # æ ¹æ® FTP å¼€å…³çŠ¶æ€æ˜¾ç¤ºä¸åŒä¿¡æ¯
          if [[ "${{ github.event.inputs.enable_ftp }}" == "true" ]]; then
            echo "âœ… å·²ä¸Šä¼ åˆ° FTP æœåŠ¡å™¨"
          else
            echo "â­ï¸  å·²è·³è¿‡ FTP ä¸Šä¼ "
          fi

          # æ ¹æ® Docker Hub å¼€å…³çŠ¶æ€æ˜¾ç¤ºä¸åŒä¿¡æ¯
          if [[ "${{ github.event.inputs.enable_dockerhub_push }}" == "true" ]]; then
            HUB_IMAGE="${{ github.event.inputs.dockerhub_image_name }}"
            if [ -z "$HUB_IMAGE" ]; then
              HUB_IMAGE="${{ github.event.inputs.image_name }}"
            fi
            VISIBILITY="${{ github.event.inputs.dockerhub_visibility }}"
            echo "âœ… å·²æ¨é€åˆ° Docker Hub"
            echo "é•œåƒåœ°å€: $HUB_IMAGE"
            echo "å¯è§æ€§: $VISIBILITY"
            echo "æ‹‰å–å‘½ä»¤: docker pull $HUB_IMAGE"
          else
            echo "â­ï¸  å·²è·³è¿‡ Docker Hub æ¨é€"
          fi

          echo "=========================================="
          echo ""
          echo "ğŸ“¦ ç¦»çº¿ä½¿ç”¨æ–¹æ³•:"
          echo "1. ä¸‹è½½ TAR æ–‡ä»¶"
          echo "2. è¿è¡Œ: docker load -i ${{ env.IMAGE_FILE }}"
          echo "3. è¿è¡Œ: docker run -it ${{ github.event.inputs.image_name }}"
          echo "=========================================="
