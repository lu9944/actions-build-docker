name: Build Dockerfile and Upload to Aliyun OSS

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      dockerfile_path:
        description: 'Dockerfile è·¯å¾„ï¼ˆç›¸å¯¹äºä»“åº“æ ¹ç›®å½•ï¼Œä¾‹å¦‚ï¼šDockerfile æˆ– ./docker/Dockerfileï¼‰'
        required: true
        default: 'Dockerfile'
      image_name:
        description: 'æ„å»ºåçš„é•œåƒåç§°å’Œæ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼šmyapp:latestï¼‰'
        required: true
        default: 'myapp:latest'
      build_context:
        description: 'æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„ï¼ˆé»˜è®¤ä¸º Dockerfile æ‰€åœ¨ç›®å½•ï¼‰'
        required: false
        default: '.'
      oss_endpoint:
        description: 'é˜¿é‡Œäº‘ OSS Endpointï¼ˆä¾‹å¦‚ï¼šoss-cn-hangzhou.aliyuncs.comï¼‰'
        required: true
        default: 'oss-cn-hangzhou.aliyuncs.com'
      oss_bucket:
        description: 'é˜¿é‡Œäº‘ OSS Bucket åç§°'
        required: true
        default: 'my-bucket'
      oss_path:
        description: 'OSS ç›®æ ‡è·¯å¾„ï¼ˆä¾‹å¦‚ï¼šdocker-images/ï¼‰'
        required: false
        default: 'docker-images/'
      enable_release:
        description: 'æ˜¯å¦ä¸Šä¼ åˆ° GitHub Release'
        required: false
        default: false
        type: boolean
      retention_days:
        description: 'OSS æ–‡ä»¶ä¿ç•™å¤©æ•°ï¼ˆ0 ä¸ºæ°¸ä¹…ï¼‰'
        required: false
        default: '0'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Display Build Configuration
        run: |
          echo "=========================================="
          echo "Dockerfile Builder with Aliyun OSS"
          echo "=========================================="
          echo "Dockerfile è·¯å¾„: ${{ github.event.inputs.dockerfile_path }}"
          echo "é•œåƒåç§°: ${{ github.event.inputs.image_name }}"
          echo "æ„å»ºä¸Šä¸‹æ–‡: ${{ github.event.inputs.build_context }}"
          echo "OSS Endpoint: ${{ github.event.inputs.oss_endpoint }}"
          echo "OSS Bucket: ${{ github.event.inputs.oss_bucket }}"
          echo "OSS è·¯å¾„: ${{ github.event.inputs.oss_path }}"
          echo "=========================================="

      - name: Verify Dockerfile Exists
        run: |
          if [ ! -f "${{ github.event.inputs.dockerfile_path }}" ]; then
            echo "âŒ é”™è¯¯: Dockerfile æ–‡ä»¶ä¸å­˜åœ¨äº ${{ github.event.inputs.dockerfile_path }}"
            echo "è¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®"
            exit 1
          fi
          echo "âœ… Dockerfile æ–‡ä»¶å­˜åœ¨"
          echo ""
          echo "Dockerfile å†…å®¹é¢„è§ˆ:"
          echo "=========================================="
          cat "${{ github.event.inputs.dockerfile_path }}"
          echo "=========================================="

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME || 'dockerhub_token_user' }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Display Authentication Status
        run: |
          if [ -n "$DOCKERHUB_TOKEN" ]; then
            echo "âœ… å·²ä½¿ç”¨ Docker Hub Token è®¤è¯ï¼ˆPro æ¨¡å¼ï¼‰"
          else
            echo "âš ï¸  æœªé…ç½® Docker Hub Tokenï¼Œä½¿ç”¨åŒ¿åæ¨¡å¼ï¼ˆæœ‰é™åˆ¶ï¼‰"
          fi
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Check Disk Space Before Build
        run: |
          echo "=========================================="
          echo "æ„å»ºå‰ç£ç›˜ç©ºé—´æ£€æŸ¥"
          echo "=========================================="
          df -h
          echo ""
          echo "Docker ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          docker system df
          echo "=========================================="

      - name: Build Docker Image
        run: |
          echo "æ­£åœ¨æ„å»ºé•œåƒ: ${{ github.event.inputs.image_name }}"
          echo "æ„å»ºä¸Šä¸‹æ–‡: ${{ github.event.inputs.build_context }}"
          echo "Dockerfile: ${{ github.event.inputs.dockerfile_path }}"

          # è¿›å…¥æ„å»ºä¸Šä¸‹æ–‡ç›®å½•
          cd "${{ github.event.inputs.build_context }}"

          # è®¡ç®—ç›¸å¯¹è·¯å¾„
          BUILD_CONTEXT="${{ github.event.inputs.build_context }}"
          DOCKERFILE="${{ github.event.inputs.dockerfile_path }}"

          # å¦‚æœ Dockerfile åœ¨æ„å»ºä¸Šä¸‹æ–‡å†…éƒ¨ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„
          if [[ "$DOCKERFILE" == "$BUILD_CONTEXT"* ]]; then
            # ç§»é™¤æ„å»ºä¸Šä¸‹æ–‡å‰ç¼€ï¼Œå¾—åˆ°ç›¸å¯¹äºæ„å»ºä¸Šä¸‹æ–‡çš„è·¯å¾„
            RELATIVE_DOCKERFILE="${DOCKERFILE#$BUILD_CONTEXT/}"
            echo "ä½¿ç”¨ç›¸å¯¹ Dockerfile è·¯å¾„: $RELATIVE_DOCKERFILE"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "Dockerfile å­˜åœ¨æ£€æŸ¥: $(test -f "$RELATIVE_DOCKERFILE" && echo 'å­˜åœ¨' || echo 'ä¸å­˜åœ¨')"

            docker build \
              -f "$RELATIVE_DOCKERFILE" \
              -t "${{ github.event.inputs.image_name }}" \
              .
          else
            # Dockerfile åœ¨æ„å»ºä¸Šä¸‹æ–‡å¤–éƒ¨ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„
            echo "ä½¿ç”¨ç»å¯¹ Dockerfile è·¯å¾„: $DOCKERFILE"
            docker build \
              -f "../$DOCKERFILE" \
              -t "${{ github.event.inputs.image_name }}" \
              .
          fi

      - name: Display Image Details
        run: |
          echo "æ„å»ºå®Œæˆçš„é•œåƒä¿¡æ¯:"
          docker images ${{ github.event.inputs.image_name }}
          echo ""
          echo "é•œåƒè¯¦ç»†ä¿¡æ¯:"
          docker inspect ${{ github.event.inputs.image_name }} --format='{{.Id}}'
          docker inspect ${{ github.event.inputs.image_name }} --format='æ„å»ºæ—¶é—´: {{.Created}}'
          docker inspect ${{ github.event.inputs.image_name }} --format='é•œåƒå¤§å°: {{.Size}}'

      - name: Clean Docker Cache Before Save
        run: |
          echo "æ¸…ç† Docker æ„å»ºç¼“å­˜ä»¥é‡Šæ”¾ç©ºé—´..."
          docker builder prune -af
          echo "æ¸…ç†æ‚¬æŒ‚é•œåƒ..."
          docker image prune -f
          echo "æ¸…ç†å®Œæˆåçš„ç£ç›˜ç©ºé—´:"
          df -h

      - name: Save Image as TAR
        run: |
          # å°†é•œåƒåç§°ä¸­çš„ / å’Œ : æ›¿æ¢ä¸ºä¸‹åˆ’çº¿ï¼Œä½œä¸ºæ–‡ä»¶å
          SAFE_NAME=$(echo "${{ github.event.inputs.image_name }}" | sed 's/[\/:]/_/g')
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "IMAGE_FILE=${SAFE_NAME}.tar" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=docker-image-${SAFE_NAME}" >> $GITHUB_ENV
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          echo "æ­£åœ¨ä¿å­˜é•œåƒä¸º: ${SAFE_NAME}.tar"

          # æ£€æŸ¥å¯ç”¨ç©ºé—´
          AVAILABLE_SPACE=$(df -BG / | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "å½“å‰å¯ç”¨ç©ºé—´: ${AVAILABLE_SPACE}GB"

          if [ "$AVAILABLE_SPACE" -lt 5 ]; then
            echo "âš ï¸  è­¦å‘Š: å¯ç”¨ç£ç›˜ç©ºé—´ä¸è¶³ 5GBï¼Œå¯èƒ½æ— æ³•å®Œæˆå¯¼å‡º"
            echo "å°è¯•è¿›ä¸€æ­¥æ¸…ç†..."
            docker system prune -f --volumes
            df -h
          fi

          # ä¿å­˜é•œåƒ
          docker save -o ${SAFE_NAME}.tar ${{ github.event.inputs.image_name }}

      - name: Display TAR File Size
        run: |
          echo "TAR æ–‡ä»¶ä¿¡æ¯:"
          ls -lh ${{ env.IMAGE_FILE }}
          echo "æ–‡ä»¶å¤§å°è¯¦æƒ…:"
          du -h ${{ env.IMAGE_FILE }}
          echo ""
          echo "æ–‡ä»¶ä¿¡æ¯:"
          file ${{ env.IMAGE_FILE }}

      - name: Setup Aliyun OSS CLI
        run: |
          # ä¸‹è½½å¹¶å®‰è£… ossutil
          wget https://gosspublic.alicdn.com/ossutil/1.7.16/ossutil64
          chmod +x ossutil64
          sudo mv ossutil64 /usr/local/bin/ossutil
          echo "âœ… ossutil å®‰è£…å®Œæˆ"
          ossutil version

      - name: Configure Aliyun OSS
        run: |
          # é…ç½® ossutil
          ossutil config -e ${{ github.event.inputs.oss_endpoint }} \
            -i ${{ secrets.ALIYUN_OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.ALIYUN_OSS_ACCESS_KEY_SECRET }} \
            -L CH \
            --loglevel info

      - name: Upload to Aliyun OSS
        run: |
          echo "=========================================="
          echo "å¼€å§‹ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ OSS"
          echo "=========================================="
          echo "OSS Endpoint: ${{ github.event.inputs.oss_endpoint }}"
          echo "OSS Bucket: ${{ github.event.inputs.oss_bucket }}"
          echo "OSS è·¯å¾„: ${{ github.event.inputs.oss_path }}"
          echo "æ–‡ä»¶: ${{ env.IMAGE_FILE }}"

          # ç¡®ä¿è·¯å¾„ä»¥ / ç»“å°¾
          OSS_PATH="${{ github.event.inputs.oss_path }}"
          if [[ "${OSS_PATH: -1}" != "/" ]]; then
            OSS_PATH="${OSS_PATH}/"
          fi

          # æ„å»ºå®Œæ•´çš„ OSS è·¯å¾„
          FULL_OSS_PATH="oss://${{ github.event.inputs.oss_bucket }}/${OSS_PATH}${{ env.IMAGE_FILE }}"

          echo "ç›®æ ‡è·¯å¾„: $FULL_OSS_PATH"

          # ä¸Šä¼ æ–‡ä»¶åˆ° OSS
          ossutil cp "${{ env.IMAGE_FILE }}" "$FULL_OSS_PATH" -f

          echo ""
          echo "=========================================="
          echo "âœ… OSS ä¸Šä¼ å®Œæˆ!"
          echo "=========================================="

          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          ossutil ls "$FULL_OSS_PATH" -l

      - name: Set OSS Lifecycle (if retention_days > 0)
        if: ${{ github.event.inputs.retention_days != '0' }}
        run: |
          echo "è®¾ç½® OSS æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸ: ${{ github.event.inputs.retention_days }} å¤©"

          # ç¡®ä¿è·¯å¾„ä»¥ / ç»“å°¾
          OSS_PATH="${{ github.event.inputs.oss_path }}"
          if [[ "${OSS_PATH: -1}" != "/" ]]; then
            OSS_PATH="${OSS_PATH}/"
          fi

          # ä¸ºæ–‡ä»¶è®¾ç½®ç”Ÿå‘½å‘¨æœŸæ ‡ç­¾
          FULL_OSS_PATH="oss://${{ github.event.inputs.oss_bucket }}/${OSS_PATH}${{ env.IMAGE_FILE }}"

          # æ·»åŠ ç”Ÿå‘½å‘¨æœŸæ ‡ç­¾ï¼ˆéœ€è¦ bucket å·²é…ç½®ç”Ÿå‘½å‘¨æœŸè§„åˆ™ï¼‰
          ossutil tag "${FULL_OSS_PATH}" \
            --add "retention=${{ github.event.inputs.retention_days }}" \
            --add "upload-date=${{ env.TIMESTAMP }}"

      - name: Create Release and Upload TAR
        if: ${{ github.event.inputs.enable_release == 'true' }}
        run: |
          # ç”Ÿæˆ Release tag
          RELEASE_TAG="docker-build-${{ env.TIMESTAMP }}"
          echo "RELEASE_TAG=${RELEASE_TAG}" >> $GITHUB_ENV

          # åˆ›å»º Release
          gh release create "${RELEASE_TAG}" \
            --title "${{ env.ARTIFACT_NAME }} - ${{ env.TIMESTAMP }}" \
            --notes "## Docker é•œåƒæ„å»ºå¯¼å‡º

            - **é•œåƒåç§°**: \`${{ github.event.inputs.image_name }}\`
            - **Dockerfile è·¯å¾„**: \`${{ github.event.inputs.dockerfile_path }}\`
            - **æ„å»ºæ—¶é—´**: ${{ env.TIMESTAMP }}
            - **æ–‡ä»¶å¤§å°**: ${{ env.IMAGE_FILE }}

            ### ä½¿ç”¨æ–¹æ³•

            \`\`\`bash
            # ä¸‹è½½ååŠ è½½é•œåƒ
            docker load -i ${{ env.IMAGE_FILE }}

            # è¿è¡Œé•œåƒ
            docker run -it ${{ github.event.inputs.image_name }}
            \`\`\`

            ### æ„å»ºä¿¡æ¯
            - æ­¤é•œåƒä» Dockerfile æ„å»ºè€Œæ¥
            - å·²ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ OSS: \`oss://${{ github.event.inputs.oss_bucket }}/${{ github.event.inputs.oss_path }}${{ env.IMAGE_FILE }}\`
            - å¯åœ¨ç¦»çº¿ç¯å¢ƒä¸­ä½¿ç”¨" \
            "${{ env.IMAGE_FILE }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "=========================================="
          echo "âœ… æ„å»ºä»»åŠ¡å®Œæˆ!"
          echo "=========================================="
          echo "é•œåƒåç§°: ${{ github.event.inputs.image_name }}"
          echo "é•œåƒå·²ä¿å­˜ä¸º: ${{ env.IMAGE_FILE }}"
          echo "Dockerfile è·¯å¾„: ${{ github.event.inputs.dockerfile_path }}"
          echo "æ„å»ºæ—¶é—´: ${{ env.TIMESTAMP }}"

          # ç¡®ä¿è·¯å¾„ä»¥ / ç»“å°¾
          OSS_PATH="${{ github.event.inputs.oss_path }}"
          if [[ "${OSS_PATH: -1}" != "/" ]]; then
            OSS_PATH="${OSS_PATH}/"
          fi

          echo ""
          echo "âœ… å·²ä¸Šä¼ åˆ°é˜¿é‡Œäº‘ OSS"
          echo "Bucket: ${{ github.event.inputs.oss_bucket }}"
          echo "è·¯å¾„: oss://${{ github.event.inputs.oss_bucket }}/${OSS_PATH}${{ env.IMAGE_FILE }}"
          echo "Endpoint: ${{ github.event.inputs.oss_endpoint }}"

          # æ ¹æ® Release å¼€å…³çŠ¶æ€æ˜¾ç¤ºä¸åŒä¿¡æ¯
          if [[ "${{ github.event.inputs.enable_release }}" == "true" ]]; then
            echo "âœ… å·²ä¸Šä¼ åˆ° GitHub Release"
            echo "Release Tag: ${{ env.RELEASE_TAG }}"
            echo "è¯·åœ¨ä¸‹æ–¹çš„ Releases åŒºåŸŸä¸‹è½½æ–‡ä»¶"
          else
            echo "â­ï¸  å·²è·³è¿‡ GitHub Release ä¸Šä¼ "
          fi

          echo "=========================================="
          echo ""
          echo "ğŸ“¦ ä¸‹è½½é•œåƒçš„æ–¹æ³•:"
          echo ""
          echo "æ–¹æ³• 1 - ä»é˜¿é‡Œäº‘ OSS ä¸‹è½½:"
          echo "  ossutil cp oss://${{ github.event.inputs.oss_bucket }}/${OSS_PATH}${{ env.IMAGE_FILE }} ."
          echo ""
          echo "æ–¹æ³• 2 - ä»æµè§ˆå™¨ä¸‹è½½ï¼ˆå¦‚æœ Bucket è®¾ç½®äº†å…¬å…±è¯»ï¼‰:"
          echo "  https://${{ github.event.inputs.oss_bucket }}.${{ github.event.inputs.oss_endpoint }}/${OSS_PATH}${{ env.IMAGE_FILE }}"
          echo ""
          echo "æ–¹æ³• 3 - ä½¿ç”¨ ossutil å‘½ä»¤:"
          echo "  ossutil get oss://${{ github.event.inputs.oss_bucket }}/${OSS_PATH}${{ env.IMAGE_FILE }}"
          echo ""
          echo "ğŸ“¦ ç¦»çº¿ä½¿ç”¨æ–¹æ³•:"
          echo "1. ä¸‹è½½ TAR æ–‡ä»¶"
          echo "2. è¿è¡Œ: docker load -i ${{ env.IMAGE_FILE }}"
          echo "3. è¿è¡Œ: docker run -it ${{ github.event.inputs.image_name }}"
          echo "=========================================="
