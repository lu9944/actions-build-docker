name: Pull Docker Image and Save as TAR

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker 镜像名称（例如：nginx:latest）'
        required: true
        default: 'nginx:latest'
      enable_release:
        description: '是否上传到 GitHub Release'
        required: false
        default: true
        type: boolean
      enable_ftp:
        description: '是否启用 FTP 上传'
        required: false
        default: false
        type: boolean
      ftp_port:
        description: 'FTP 端口（默认：21）'
        required: false
        default: '21'
      ftp_path:
        description: 'FTP 目标路径（例如：/docker-images/）'
        required: false
        default: '/'

jobs:
  pull-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: Display Image Information
        run: |
          echo "=========================================="
          echo "Docker Image Puller"
          echo "=========================================="
          echo "镜像名称: ${{ github.event.inputs.image_name }}"
          echo "=========================================="

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME || 'dockerhub_token_user' }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Display Authentication Status
        run: |
          if [ -n "$DOCKERHUB_TOKEN" ]; then
            echo "✅ 已使用 Docker Hub Token 认证（Pro 模式）"
          else
            echo "⚠️  未配置 Docker Hub Token，使用匿名模式（有限制）"
          fi
        env:
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Configure Docker to use /mnt
        run: |
          echo "=========================================="
          echo "重新配置 Docker 数据目录到 /mnt"
          echo "=========================================="

          # 停止 Docker 服务
          sudo systemctl stop docker docker.socket containerd

          # 创建新的 Docker 数据目录
          sudo mkdir -p /mnt/docker

          # 配置 Docker 使用新目录
          sudo tee /etc/docker/daemon.json > /dev/null <<EOF
          {
            "data-root": "/mnt/docker"
          }
          EOF

          # 迁移现有数据（如果需要）
          if [ -d "/var/lib/docker" ] && [ "$(ls -A /var/lib/docker)" ]; then
            echo "迁移现有 Docker 数据..."
            sudo rsync -aP /var/lib/docker/ /mnt/docker/
          fi

          # 启动 Docker 服务
          sudo systemctl start docker

          # 等待 Docker 就绪
          echo "等待 Docker 启动..."
          timeout 30 bash -c 'until docker info >/dev/null 2>&1; do sleep 1; done' || {
            echo "Docker 启动失败"
            sudo systemctl status docker
            exit 1
          }

          echo "✅ Docker 已重新配置并启动"
          docker info | grep "Docker Root Dir"
          echo "=========================================="

      - name: Check Disk Space
        run: |
          echo "=========================================="
          echo "磁盘空间检查"
          echo "=========================================="
          df -h
          echo ""
          echo "Docker 磁盘使用情况:"
          docker system df
          echo "=========================================="

      - name: Pull Docker Image
        run: |
          echo "正在拉取镜像: ${{ github.event.inputs.image_name }}"
          docker pull ${{ github.event.inputs.image_name }}

      - name: Display Image Details
        run: |
          echo "镜像信息:"
          docker images ${{ github.event.inputs.image_name }}

      - name: Clean Docker Cache
        run: |
          echo "清理 Docker 构建缓存以释放空间..."
          docker builder prune -af
          echo "清理悬挂镜像..."
          docker image prune -f
          echo "清理完成后的磁盘空间:"
          df -h

      - name: Save Image as TAR
        run: |
          # 将镜像名称中的 / 和 : 替换为下划线，作为文件名和 artifact 名称
          SAFE_NAME=$(echo "${{ github.event.inputs.image_name }}" | sed 's/[\/:]/_/g')
          IMAGE_FILE="/mnt/${SAFE_NAME}.tar"
          echo "IMAGE_FILE=${IMAGE_FILE}" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=docker-image-${SAFE_NAME}" >> $GITHUB_ENV
          echo "正在保存镜像为: ${IMAGE_FILE}"

          # 检查 /mnt 可用空间
          AVAILABLE_SPACE=$(df -BG /mnt | awk 'NR==2 {print $4}' | sed 's/G//')
          echo "/mnt 可用空间: ${AVAILABLE_SPACE}GB"

          if [ "$AVAILABLE_SPACE" -lt 5 ]; then
            echo "⚠️  警告: /mnt 可用磁盘空间不足 5GB，可能无法完成导出"
            echo "尝试进一步清理..."
            docker system prune -f --volumes
            df -h /mnt
          fi

          # 保存镜像到 /mnt 目录
          docker save -o ${IMAGE_FILE} ${{ github.event.inputs.image_name }}

      - name: Display TAR File Size
        run: |
          echo "TAR 文件信息:"
          ls -lh ${{ env.IMAGE_FILE }}
          echo "文件大小详情:"
          du -h ${{ env.IMAGE_FILE }}

      - name: Generate Release Info
        if: ${{ github.event.inputs.enable_release == 'true' }}
        run: |
          # 生成时间戳作为 Release tag
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "RELEASE_TAG=docker-image-${TIMESTAMP}" >> $GITHUB_ENV
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV

      - name: Create Release and Upload TAR
        if: ${{ github.event.inputs.enable_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "${{ env.ARTIFACT_NAME }} - ${{ env.TIMESTAMP }}"
          body: |
            ## Docker 镜像导出

            - **镜像名称**: `${{ github.event.inputs.image_name }}`
            - **导出时间**: ${{ env.TIMESTAMP }}
            - **文件大小**: ${{ env.IMAGE_FILE }}

            ### 使用方法

            ```bash
            # 下载后加载镜像
            docker load -i ${{ env.IMAGE_FILE }}

            # 运行镜像
            docker run -it ${{ github.event.inputs.image_name }}
            ```
          files: ${{ env.IMAGE_FILE }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to FTP
        if: ${{ github.event.inputs.enable_ftp == 'true' }}
        run: |
          echo "=========================================="
          echo "开始上传到 FTP 服务器"
          echo "=========================================="
          echo "FTP 服务器: *** (已配置)"
          echo "FTP 端口: ${{ github.event.inputs.ftp_port }}"
          echo "FTP 路径: ${{ github.event.inputs.ftp_path }}"
          echo "文件: ${{ env.IMAGE_FILE }}"

          # 确保路径以 / 结尾
          FTP_PATH="${{ github.event.inputs.ftp_path }}"
          if [[ "${FTP_PATH: -1}" != "/" ]]; then
            FTP_PATH="${FTP_PATH}/"
          fi

          # 使用 curl 上传文件到 FTP
          curl -T "${{ env.IMAGE_FILE }}" \
            "ftp://${{ secrets.FTP_SERVER }}:${{ github.event.inputs.ftp_port }}${FTP_PATH}${{ env.IMAGE_FILE }}" \
            --user "${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }}" \
            --ftp-create-dirs \
            -v

          echo "=========================================="
          echo "✅ FTP 上传完成!"
          echo "=========================================="

      - name: Summary
        run: |
          echo "=========================================="
          echo "✅ 任务完成!"
          echo "=========================================="
          echo "镜像已保存为: ${{ env.IMAGE_FILE }}"

          # 根据 Release 开关状态显示不同信息
          if [[ "${{ github.event.inputs.enable_release }}" == "true" ]]; then
            echo "✅ 已上传到 GitHub Release"
            echo "Release Tag: ${{ env.RELEASE_TAG }}"
            echo "请在下方的 Releases 区域下载文件"
          else
            echo "⏭️  已跳过 GitHub Release 上传"
          fi

          # 根据 FTP 开关状态显示不同信息
          if [[ "${{ github.event.inputs.enable_ftp }}" == "true" ]]; then
            echo "✅ 已上传到 FTP 服务器"
          else
            echo "⏭️  已跳过 FTP 上传"
          fi

          echo "=========================================="
