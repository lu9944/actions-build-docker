name: Pull Docker Image and Save as TAR

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker 镜像名称（例如：nginx:latest）'
        required: true
        default: 'nginx:latest'

jobs:
  pull-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: Display Image Information
        run: |
          echo "=========================================="
          echo "Docker Image Puller"
          echo "=========================================="
          echo "镜像名称: ${{ github.event.inputs.image_name }}"
          echo "=========================================="

      - name: Pull Docker Image
        run: |
          echo "正在拉取镜像: ${{ github.event.inputs.image_name }}"
          docker pull ${{ github.event.inputs.image_name }}

      - name: Display Image Details
        run: |
          echo "镜像信息:"
          docker images ${{ github.event.inputs.image_name }}

      - name: Save Image as TAR
        run: |
          # 将镜像名称中的 / 和 : 替换为下划线，作为文件名和 artifact 名称
          SAFE_NAME=$(echo "${{ github.event.inputs.image_name }}" | sed 's/[\/:]/_/g')
          echo "IMAGE_FILE=${SAFE_NAME}.tar" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=docker-image-${SAFE_NAME}" >> $GITHUB_ENV
          echo "正在保存镜像为: ${SAFE_NAME}.tar"
          docker save -o ${SAFE_NAME}.tar ${{ github.event.inputs.image_name }}

      - name: Display TAR File Size
        run: |
          echo "TAR 文件信息:"
          ls -lh ${{ env.IMAGE_FILE }}
          echo "文件大小详情:"
          du -h ${{ env.IMAGE_FILE }}

      - name: Generate Release Info
        run: |
          # 生成时间戳作为 Release tag
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "RELEASE_TAG=docker-image-${TIMESTAMP}" >> $GITHUB_ENV
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV

      - name: Create Release and Upload TAR
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "${{ env.ARTIFACT_NAME }} - ${{ env.TIMESTAMP }}"
          body: |
            ## Docker 镜像导出

            - **镜像名称**: `${{ github.event.inputs.image_name }}`
            - **导出时间**: ${{ env.TIMESTAMP }}
            - **文件大小**: ${{ env.IMAGE_FILE }}

            ### 使用方法

            ```bash
            # 下载后加载镜像
            docker load -i ${{ env.IMAGE_FILE }}

            # 运行镜像
            docker run -it ${{ github.event.inputs.image_name }}
            ```
          files: ${{ env.IMAGE_FILE }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "=========================================="
          echo "✅ 任务完成!"
          echo "=========================================="
          echo "镜像已保存为: ${{ env.IMAGE_FILE }}"
          echo "Release Tag: ${{ env.RELEASE_TAG }}"
          echo "请在下方的 Releases 区域下载文件"
          echo "=========================================="
